name: CI â€“ Validate and Upload to S3

on:
  push:
    branches:
      - feature/**
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate BPML XML
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-utils
        xmllint --noout business-processes/*.bpml

    - name: Create ZIP of config
      run: |
        zip -r artifact.zip business-processes

    - name: Generate version tag
      id: version
      run: |
        VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Configure AWS via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::<YOUR_AWS_ACCOUNT>:role/GitHubOIDCDeployRole
        aws-region: ap-south-1

    - name: Upload to S3
      run: |
        aws s3 cp artifact.zip s3://$S3_BUCKET/bpml-${{ env.VERSION }}.zip





