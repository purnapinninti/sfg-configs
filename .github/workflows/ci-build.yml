name: CI â€“ Validate & Package SFG Configs

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: linux-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install XML Tools
        run: sudo yum install -y libxml2-utils

      - name: Validate BPML Files
        run: |
          echo "Validating BPML..."
          for f in business-processes/*.bpml; do
            echo "Checking $f"
            xmllint --noout "$f"
          done

      - name: Determine Version
        id: version
        run: |
          # Auto-bump version using commit count
          VERSION="1.0.$(git rev-list --count HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Calculated VERSION = $VERSION"

      - name: Create Build Package
        run: |
          mkdir build
          cp -r business-processes build/
          cp -r routing build/
          cp -r maps build/
          cp -r partners build/
          zip -r sfg-package-${{ steps.version.outputs.version }}.zip build

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: sfg-package-${{ steps.version.outputs.version }}
          path: sfg-package-${{ steps.version.outputs.version }}.zip

      - name: Tag Repo
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-south-1
          role-to-assume: arn:aws:iam::043809027222:role/sfg
          role-session-name: sfg

      - name: Upload artifact to S3
        run: |
          aws s3 cp sfg-package-${{ steps.version.outputs.version }}.zip \
            s3://sfg-artifacts-demo/dev/sfg-package-${{ steps.version.outputs.version }}.zip

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-south-1
          role-to-assume: arn:aws:iam::043809027222:role/
          role-session-name: sfg

      - name: Upload to S3
        run: |
          aws s3 cp sfg-package-${{ steps.version.outputs.version }}.zip \
            s3://sfg-artifacts-demo/dev/sfg-package-${{ steps.version.outputs.version }}.zip



